name: Backend Dev Docker CD

on:
  push:
    branches: [ dev ]
    paths-ignore:
      - '**/README.md'
      - '**/.gitignore'

jobs:
  build-and-deploy:
    runs-on: [ self-hosted, linux, X64 ] 

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build JAR
        run: |
          ./gradlew clean build -x test
          cp build/libs/newsum-0.0.1-SNAPSHOT.jar app.jar

      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ap-northeast-2

      - name: Docker ECR Login
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      # Docker Buildx ì„¤ì¹˜ ë° ì„¤ì •
      - name: Setup Docker Buildx
        run: |
          BUILDX_VERSION="v0.24.0" # <-- Buildx ë²„ì „ ëª…ì‹œ
          BUILDX_DIR="/usr/local/lib/docker/cli-plugins"
          BUILDX_BIN="$BUILDX_DIR/docker-buildx"

          sudo mkdir -p "$BUILDX_DIR"

          # ëŸ¬ë„ˆ ì•„í‚¤í…ì²˜ì— ë§ëŠ” Buildx ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (X64 ëŸ¬ë„ˆì´ë¯€ë¡œ linux-amd64)
          BUILDX_URL="https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-amd64"

          echo "Downloading buildx from $BUILDX_URL to $BUILDX_BIN"
          sudo curl -L "$BUILDX_URL" -o "$BUILDX_BIN"
          sudo chmod a+x "$BUILDX_BIN"

          echo "Docker Buildx version after setup:"
          docker buildx version # ì„¤ì¹˜ í™•ì¸ì„ ìœ„í•œ ëª…ë ¹

      # arm ì•„í‚¤í…ì²˜ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build & Push ARM image with tag `dev`
        run: |
          IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:dev"
          docker buildx inspect multi-arch >/dev/null 2>&1 || docker buildx create --name multi-arch --use --driver docker-container --bootstrap
          docker buildx use multi-arch
          
          docker buildx build \
            --platform linux/arm64 \
            --tag "$IMAGE" \
            --push \
            .
      # íƒœê·¸ë¡œ ì¸ìŠ¤í„´ìŠ¤ IP ê°€ì ¸ì˜¤ê¸°
      - name: Get EC2 Private IPs by Tag
        id: fetch
        run: |
          IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Role,Values=newsum-backend" \
                      "Name=tag:Environment,Values=dev" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PrivateIpAddress' \
            --output text)
          
          # IP ë¦¬ìŠ¤íŠ¸ ë””ë²„ê¹… ì¶œë ¥
          echo "IPS: $IPS"
          
          # ì¤„ë°”ê¿ˆ ì œê±°í•˜ê³  ê³µë°± êµ¬ë¶„ì˜ í•œ ì¤„ë¡œ ë§Œë“¤ì–´ ì¶œë ¥
          IPS_SINGLE_LINE=$(echo $IPS | tr '\n' ' ')
          echo "ips=$IPS_SINGLE_LINE" >> "$GITHUB_OUTPUT"

      - name: Deploy to WAS EC2 via SSH
        run: |
          # GitHub Actions ì‹œí¬ë¦¿ì„ ì‰˜ ë³€ìˆ˜ë¡œ ë¨¼ì € í• ë‹¹
          ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
          ECR_REPO=${{ secrets.ECR_REPO }}
          SSH_KEY_PATH=${{ secrets.SSH_KEY_PATH }}
          INFISICAL_URL=${{ secrets.AWS_CLOUDFRONT_URL }}
          INFISICAL_PROJECT_ID=${{ secrets.INFISICAL_PROJECT_ID }}
          INFISICAL_TOKEN=${{ secrets.INFISICAL_TOKEN_DEV }}
          INFISICAL_ENV=${{ secrets.INFISICAL_ENV_DEV }}
          INFISICAL_API_URL=${{ secrets.INFISICAL_API_URL }}
          
          for IP in ${{ steps.fetch.outputs.ips }}; do
            echo "ğŸš€ ë°°í¬ ì¤‘: $IP"

            # Self-hosted-runner ë‚´ë¶€ í‚¤ ê²½ë¡œ
            ssh -o StrictHostKeyChecking=no -i $SSH_KEY_PATH ubuntu@$IP <<-EOF
              # ECR ë¡œê·¸ì¸
              aws ecr get-login-password --region ap-northeast-2 \
              | docker login --username AWS --password-stdin $ECR_REGISTRY

              # .env ìƒì„±
              curl -Ls https://$INFISICAL_URL/tools/infisical-linux-arm64 -o infisical
              chmod +x infisical && sudo mv infisical /usr/local/bin/infisical
              infisical export \
                --env=$INFISICAL_ENV \
                --projectId=$INFISICAL_PROJECT_ID \
                --token=$INFISICAL_TOKEN \
                --format=dotenv \
                --domain=$INFISICAL_API_URL > /home/ubuntu/newsum-backend.env
          
              # valueì— ë”°ì˜´í‘œ ì œê±° (Infisicalì—ì„œ ë¬¸ìì—´ì´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ì ¸ ë‚˜ì˜¬ ë•Œ ìœ ìš©)
              sed -i "s/=['\"]\([^'\"]*\)['\"]$/=\1/" /home/ubuntu/newsum-backend.env

              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
              docker stop newsum_backend || true
              docker rm newsum_backend || true

              # ìƒˆ ì´ë¯¸ì§€ pull í›„ ì‹¤í–‰
              docker pull $ECR_REGISTRY/$ECR_REPO:dev
              docker run -d \
                --name newsum_backend \
                --restart=always \
                --env-file /home/ubuntu/newsum-backend.env \
                -p 8080:8080 \
                $ECR_REGISTRY/$ECR_REPO:dev
          
              # ğŸ” í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì‚­ì œ
              rm -f /home/ubuntu/newsum-backend.env
          EOF
          done
